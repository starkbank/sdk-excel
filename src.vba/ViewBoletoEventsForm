
Private Sub AfterTextBox_Change()
    Static reentry As Boolean
    If reentry Then Exit Sub
    
    reentry = True
    AfterTextBox.text = Utils.formatDateInUserForm(AfterTextBox.text)
    reentry = False
End Sub

Private Sub BeforeTextBox_Change()
    Static reentry As Boolean
    If reentry Then Exit Sub
    
    reentry = True
    BeforeTextBox.text = Utils.formatDateInUserForm(BeforeTextBox.text)
    reentry = False
End Sub

Private Sub UserForm_Initialize()
    Me.OptionButtonEventCredited.Enabled = True
    
    Me.AfterTextBox.Value = InputLogGateway.getAfterDate()
    Me.BeforeTextBox.Value = InputLogGateway.getBeforeDate()
End Sub

Private Sub SearchButton_Click()
    ' On Error Resume Next
    
    If Not isSignedin() Then
        MsgBox "Acesso negado, faça login novamente."
        Unload Me
        Exit Sub
    End If
    
    Dim afterInput As String: afterInput = AfterTextBox.Value
    Dim beforeInput As String: beforeInput = BeforeTextBox.Value
    
    Dim after As String: after = Utils.DateToSendingFormat(afterInput)
    Dim before As String: before = Utils.DateToSendingFormat(beforeInput)
    
    Dim id As String
    Dim amount As Double
    Dim fee As Double
    Dim issueDate As String
    Dim eventDate As String
    Dim boletoStatus As String
    Dim logEvent As String
    Dim dueDate As String
    Dim tags As Collection
    
    Dim cursor As String
    Dim boleto As Object
    Dim boletoLog As Object
    Dim boletos As Collection
    Dim boletoLogs As Collection
    Dim row As Long
    Dim logRow As Long
    Dim optionalParam As Dictionary: Set optionalParam = New Dictionary
    Dim rng As Range
    
    Dim logsPaidByBoleto As Dictionary: Set logsPaidByBoleto = New Dictionary
    Dim logsRegisteredByBoleto As Dictionary: Set logsRegisteredByBoleto = New Dictionary
    
    Call InputLogGateway.saveDates(afterInput, beforeInput)
    
    'Table layout
    Utils.applyStandardLayout ("V")
    ActiveSheet.Hyperlinks.Delete
    Range("A" & CStr(TableFormat.HeaderRow() + 1) & ":V" & Rows.Count).ClearContents
    
    'Headers definition
    
    ActiveSheet.Cells(TableFormat.HeaderRow(), 1).Value = "Data do Evento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 2).Value = "Evento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 3).Value = "Nome"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 4).Value = "CPF/CNPJ"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 5).Value = "Valor"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 6).Value = "Valor de Emissão"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 7).Value = "Desconto"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 8).Value = "Multa"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 9).Value = "Juros"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 10).Value = "Data de Emissão"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 11).Value = "Vencimento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 12).Value = "Linha Digitável"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 13).Value = "Id do Boleto"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 14).Value = "Tarifa"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 15).Value = "Tags"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 16).Value = "Link PDF"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 17).Value = "Logradouro"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 18).Value = "Complemento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 19).Value = "Bairro"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 20).Value = "Cidade"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 21).Value = "Estado"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 22).Value = "CEP"
    
    Call FreezeHeader
    
    'Optional parameters
    
    If after <> "--" Then
        optionalParam.Add "after", after
    End If
    If before <> "--" Then
        optionalParam.Add "before", before
    End If
    
    Dim Events As String: Events = ""

    If OptionButtonEventCanceled.Value Then
        Events = Events + "canceled,"
    End If
    If OptionButtonEventOverdue.Value Then
        Events = Events + "overdue,"
    End If
    If OptionButtonEventCredited.Value Then
        Events = Events + "credited,"
    End If
    
    row = TableFormat.HeaderRow() + 1
    If Events <> "credited," Then
        optionalParam.Add "types", Events
        Do
            Set respJson = BoletoGateway.getBoletoLogs(cursor, optionalParam)
            cursor = ""
            If respJson("cursor") <> "" Then
                cursor = respJson("cursor")
            End If
    
            Set logs = respJson("logs")
            If logs.Count = 0 Then
                Exit Do
            End If
            
            For Each boletoLog In logs
                
                Set boleto = boletoLog("boleto")
                
                logEvent = boletoLog("type")
                id = boleto("id")
                amount = boleto("amount") / 100
                fee = boleto("fee") / 100
                eventDate = boletoLog("created")
                issueDate = boleto("created")
                boletoStatus = boleto("status")
                dueDate = boleto("due")
                Set tags = boleto("tags")
                
                ActiveSheet.Cells(row, 1).Value = Utils.ISODATEZ(eventDate)
                ActiveSheet.Cells(row, 2).Value = BoletoGateway.getEventInPt(logEvent)
                ActiveSheet.Cells(row, 3).Value = boleto("name")
                ActiveSheet.Cells(row, 4).Value = boleto("taxId")
                ActiveSheet.Cells(row, 5).Value = amount
    
                ActiveSheet.Cells(row, 10).Value = Utils.ISODATEZ(issueDate)
                ActiveSheet.Cells(row, 11).Value = Utils.ISODATEZ(dueDate)
                ActiveSheet.Cells(row, 12).Value = boleto("line")
                ActiveSheet.Cells(row, 13).Value = id
                ActiveSheet.Cells(row, 14).Value = fee
                ActiveSheet.Cells(row, 15).Value = CollectionToString(tags, ",")
    
                ActiveSheet.Cells(row, 16).Value = "PDF"
                Set rng = ActiveSheet.Range("P" + CStr(row))
                rng.Parent.Hyperlinks.Add Anchor:=rng, address:=Rest.baseUrl() + "/v2-faks/boleto/" + boleto("id") + "/pdf", SubAddress:="", TextToDisplay:="PDF"
                row = row + 1
            Next
        Loop While cursor <> ""
        Unload Me
        Exit Sub
    End If

    optionalParam.Add "types", Events
    Do
        logRow = row
        Set respJson = BoletoGateway.getBoletoLogs(cursor, optionalParam)
        If respJson.Exists("errors") Then
            Unload Me
            Exit Sub
        End If

        cursor = ""
        If respJson("cursor") <> "" Then
            cursor = respJson("cursor")
        End If

        Set logs = respJson("logs")

        For Each boletoLog In logs
            Set boleto = boletoLog("boleto")
            
            eventDate = boletoLog("created")
            logEvent = boletoLog("type")
            id = boleto("id")
            amount = boleto("amount") / 100
            fee = boleto("fee") / 100
            issueDate = boleto("created")
            boletoStatus = boleto("status")
            dueDate = boleto("due")
            Set tags = boleto("tags")
            
            ActiveSheet.Cells(row, 1).Value = Utils.ISODATEZ(eventDate)
            ActiveSheet.Cells(row, 2).Value = BoletoGateway.getEventInPt(logEvent)
            ActiveSheet.Cells(row, 3).Value = boleto("name")
            ActiveSheet.Cells(row, 4).Value = boleto("taxId")
            
            ActiveSheet.Cells(row, 5).Value = amount

            ActiveSheet.Cells(row, 10).Value = Utils.ISODATEZ(issueDate)
            ActiveSheet.Cells(row, 11).Value = Utils.ISODATEZ(dueDate)
            ActiveSheet.Cells(row, 12).Value = boleto("line")
            ActiveSheet.Cells(row, 13).Value = id
            ActiveSheet.Cells(row, 14).Value = fee
            ActiveSheet.Cells(row, 15).Value = CollectionToString(tags, ",")

            ActiveSheet.Cells(row, 16).Value = "PDF"
            Set rng = ActiveSheet.Range("P" + CStr(row))
            rng.Parent.Hyperlinks.Add Anchor:=rng, address:=Rest.baseUrl() + "/v2-faks/boleto/" + boleto("id") + "/pdf", SubAddress:="", TextToDisplay:="PDF"

            ActiveSheet.Cells(row, 17).Value = boleto("streetLine1")
            ActiveSheet.Cells(row, 18).Value = boleto("streetLine2")
            ActiveSheet.Cells(row, 19).Value = boleto("district")
            ActiveSheet.Cells(row, 20).Value = boleto("city")
            ActiveSheet.Cells(row, 21).Value = boleto("stateCode")
            ActiveSheet.Cells(row, 22).Value = boleto("zipCode")

            If boletoStatus = "paid" And Not logsPaidByBoleto.Exists(id) Then
                logsPaidByBoleto.Add id, boletoLog
                logsRegisteredByBoleto.Add id, New Dictionary
            End If

            row = row + 1
        Next

        Dim logsParam As Dictionary
        Dim Keys As String
        Dim sep As String
        Dim registeredCursor As String: registeredCursor = ""
        Keys = ""
        sep = ""
        Set logsParam = New Dictionary
        
        For Each boletoId In logsPaidByBoleto.Keys()
            Keys = Keys + sep + boletoId
            sep = ","
        Next
        logsParam.Add "boletoIds", Keys
        
        Do
            logsParam("types") = "registered,"
            Set respJson = BoletoGateway.getBoletoLogs(registeredCursor, logsParam)
            If respJson.Exists("errors") Then
                MsgBox "Erro ao obter dados detalhados de boletos registrados!"
                Exit Sub
            End If
            If respJson("cursor") <> "" Then
                registeredCursor = respJson("cursor")
            End If
            Set registeredLogs = respJson("logs")
            For Each registeredLog In registeredLogs
                Set logsRegisteredByBoleto(registeredLog("boleto")("id")) = registeredLog
            Next
        Loop While registeredCursor <> ""
        
        For Each boletoLog In logs
            Set boleto = boletoLog("boleto")
            If boleto("status") = "paid" Then
                Call setBoletoEventInfo(boleto, logsPaidByBoleto(boleto("id")), logsRegisteredByBoleto(boleto("id")), logRow)
            End If
            logRow = logRow + 1
        Next

        Set logsPaidByBoleto = New Dictionary
        Set logsRegisteredByBoleto = New Dictionary
        
    Loop While cursor <> ""
    
    Unload Me
End Sub

Public Sub setBoletoEventInfo(ByVal boleto As Object, ByVal paidLog As Dictionary, ByVal registeredLog As Dictionary, row As Long)
    Dim nominalAmount As Double
    Dim fine As Double
    Dim amount As Double
    Dim interest As Double
    Dim discount As Double
    Dim deltaAmount As Double
    Dim logs As Collection
    Dim id As String: id = boleto("id")
    
    amount = boleto("amount") / 100
    
    nominalAmount = amount
    If Not VarType(registeredLog("boleto")) = 0 Then
        nominalAmount = registeredLog("boleto")("amount") / 100
    End If
    
    deltaAmount = amount - nominalAmount
    
    ActiveSheet.Cells(row, 6).Value = nominalAmount
    If deltaAmount < 0 Then
        discount = deltaAmount
        ActiveSheet.Cells(row, 7).Value = discount
        ActiveSheet.Cells(row, 7).Font.Color = RGB(180, 0, 0)
    End If
    If deltaAmount > 0 Then
        fine = boleto("fine") / 100 * nominalAmount
        interest = amount - fine - nominalAmount
        ActiveSheet.Cells(row, 8).Value = fine
        ActiveSheet.Cells(row, 9).Value = interest
        ActiveSheet.Cells(row, 8).Font.Color = RGB(0, 140, 0)
        ActiveSheet.Cells(row, 9).Font.Color = RGB(0, 140, 0)
    End If
End Sub


