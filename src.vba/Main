
Public Sub signIn()
    If EcdsaRoutine Then
        SignInForm.Show
    End If

End Sub

Public Sub signOut()
    Dim respJson As Dictionary
    
    
    On Error Resume Next
    message1 = "Você quer mesmo encerrar a sessão? "
    message2 = "Dados que não foram salvos serão apagados."
    confirmationMessage = message1 + message2
    signOutAnswer = MsgBox(confirmationMessage, vbQuestion + vbYesNo, "Confirmação de encerramento")
    
    If signOutAnswer = vbNo Then
        Exit Sub
    End If
    
    Application.ScreenUpdating = False
    Set respJson = SessionGateway.deleteSession()
    
    If respJson.Exists("errors") Then
        MsgBox respJson("errors")(1)("message")
        Exit Sub
    End If
    
    Call SessionGateway.saveSession("", "", "", "", "", "")
    For Each WS In ThisWorkbook.Worksheets
        If WS.name <> "Credentials" And WS.name <> "InputLog" And WS.name <> "Aux" Then
        
            WS.Cells(2, 1).Value = ""
            WS.Cells(3, 1).Value = ""
            WS.Cells(4, 1).Value = ""
            WS.Cells(5, 1).Value = ""
            WS.Cells(6, 1).Value = ""
            WS.Cells(7, 1).Value = ""
        End If
    Next
    clearDates
    clearAll
    Application.ScreenUpdating = True
    
    MsgBox "Sucesso"
    
End Sub

Public Sub clearAll()
    For Each WS In ThisWorkbook.Worksheets
    
        If WS.name <> "Principal" And WS.name <> "Aux" Then
            WS.Cells.UnMerge
            WS.Range("A10:Z" & Rows.Count).ClearContents
            
            If WS.name = "InputLog" Then
                WS.Range("B:B").ClearContents
            End If
            
        End If
        
    Next
    
End Sub

Public Sub openHelp()
    With ViewHelpForm
        .MultiPage1.Value = 0
        .Show
    End With
    
End Sub

Public Sub openHelpDigSign()
    With ViewHelpForm
        .MultiPage1.Value = 2
        .Show
    End With
    
End Sub

Public Sub searchStatement()
    ViewStatementForm.Show
    
End Sub

Public Sub sendOrders()
    On Error Resume Next
    SendOrderForm.Show
    
End Sub

Public Sub searchCharges()
    ViewChargeForm.Show
    
End Sub

Public Sub searchInvoices()
    ViewInvoiceForm.Show
    
End Sub

Public Sub searchChargeEvents()
    ViewChargeEventsForm.Show
    
End Sub

Public Sub searchTransfers()
    ViewTransferForm.Show
    
End Sub

Public Sub keyGeneration()
    GenerateKeyForm.Show
    
End Sub

Public Sub keyUpload()
    SendKeyForm.Show
    
End Sub

Public Sub searchCustomers()
    Dim cursor As String
    Dim customers As Collection
    Dim row As Integer
    Dim optionalParam As Dictionary: Set optionalParam = New Dictionary
    
    
    On Error Resume Next
    If Not isSignedin() Then
        MsgBox "Acesso negado, faça login novamente."
        Exit Sub
    End If
    
    'Table layout
    Utils.applyStandardLayout ("L")
    Range("A10:L" & Rows.Count).ClearContents
    
    'Headers definition
    ActiveSheet.Cells(TableFormat.HeaderRow(), 1).Value = "Id do Cliente"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 2).Value = "Nome"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 3).Value = "CPF/CNPJ"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 4).Value = "E-mail"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 5).Value = "Telefone"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 6).Value = "Logradouro"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 7).Value = "Complemento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 8).Value = "Bairro"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 9).Value = "Cidade"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 10).Value = "Estado"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 11).Value = "CEP"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 12).Value = "Tags"
    
    With ActiveWindow
        '.SplitColumn = 12
        .SplitRow = 9
    End With
    ActiveWindow.FreezePanes = True
    
    row = 10

    Do
        Set respJson = BoletoGateway.getCustomers(cursor, optionalParam)
        cursor = ""
        
        If respJson("cursor") <> "" Then
            cursor = respJson("cursor")
        End If

        Set customers = respJson("customers")

        For Each customer In customers
            Dim address As Dictionary
            Dim tags As Collection
            
            
            ActiveSheet.Cells(row, 1).Value = customer("id")
            ActiveSheet.Cells(row, 2).Value = customer("name")
            ActiveSheet.Cells(row, 3).Value = customer("taxId")
            ActiveSheet.Cells(row, 4).Value = customer("email")
            ActiveSheet.Cells(row, 5).Value = customer("phone")
            
            Set address = customer("address")
            
            ActiveSheet.Cells(row, 6).Value = address("streetLine1")
            ActiveSheet.Cells(row, 7).Value = address("streetLine2")
            ActiveSheet.Cells(row, 8).Value = address("district")
            ActiveSheet.Cells(row, 9).Value = address("city")
            ActiveSheet.Cells(row, 10).Value = address("stateCode")
            ActiveSheet.Cells(row, 11).Value = address("zipCode")

            Set tags = customer("tags")
            ActiveSheet.Cells(row, 12).Value = CollectionToString(tags, ",")
            row = row + 1
        Next

    Loop While cursor <> ""
     
End Sub

Public Sub createBoletos()
    Dim boletos As Collection
    Dim resp As Response
    Dim initRow As Long
    Dim midRow As Long
    Dim lastRow As Long
    Dim respMessage As String


    If Not isSignedin() Then
        MsgBox "Acesso negado, faça login novamente."
        Exit Sub
        
    End If

    Call Utils.applyStandardLayout("L")

    'Headers definition
    ActiveSheet.Cells(TableFormat.HeaderRow(), 1).Value = "Nome"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 2).Value = "CPF/CNPJ"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 3).Value = "Logradouro"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 4).Value = "Complemento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 5).Value = "Bairo"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 6).Value = "Cidade"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 7).Value = "Código do Estado"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 8).Value = "CEP"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 9).Value = "Valor"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 10).Value = "Data de Vencimento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 11).Value = "Multa"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 12).Value = "Juro ao Mês"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 13).Value = "Dias para Baixa Automática"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 14).Value = "Descrição 1"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 15).Value = "Valor 1"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 16).Value = "Descrição 2"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 17).Value = "Valor 2"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 18).Value = "Descrição 3"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 19).Value = "Valor 3"

    With ActiveWindow
        .SplitRow = 9
    End With
    ActiveWindow.FreezePanes = True

    anySent = False
    returnMessage = ""
    warningMessage = ""
    errorMessage = ""

    initRow = 10
    lastRow = ActiveSheet.Cells(Rows.Count, "A").End(xlUp).row
    midRow = initRow - 1
    Do
        midRow = IIf(midRow + 50 >= lastRow, lastRow, midRow + 50)
        Set boletos = BoletoGateway.getOrders(initRow, midRow)
        Set resp = BoletoGateway.createBoletos(boletos)
        
        If resp.Status = 200 Then
            respMessage = resp.json()("message")
            MsgBox "Linhas " + CStr(initRow) + " a " + CStr(midRow) + ": " + resp.json()("message"), , "Sucesso"
            
        ElseIf resp.errors().Exists("errors") Then
            Dim errors As Collection: Set errors = resp.errors()("errors")
            Dim error As Dictionary
            Dim errorList As String
            Dim errorDescription As String
            Dim messageBox As String
            
            For Each error In errors
                errorDescription = Utils.correctErrorLine(error("message"), CLng(initRow))
                errorList = errorList & errorDescription & Chr(10)
            Next
            
            messageBox = errorList
            MsgBox messageBox, , "Erro"
            End
        Else
            MsgBox resp.errors()("errors")(1)("message"), , "Erro"
            
        End If
        
        initRow = initRow + 50
    Loop Until (midRow >= lastRow)

End Sub

Public Sub createInvoices()
    Dim invoices As Collection
    Dim resp As Response
    Dim initRow As Long
    Dim midRow As Long
    Dim lastRow As Long
    Dim respMessage As String


    If Not isSignedin Then
        MsgBox "Acesso negado. Faça login novamente.", , "Erro"
        Exit Sub
    End If
    
    Call Utils.applyStandardLayout("M")
    
    'Headers definition
    ActiveSheet.Cells(TableFormat.HeaderRow(), 1).Value = "Nome do Cliente"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 2).Value = "CPF/CNPJ do Cliente"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 3).Value = "Valor"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 4).Value = "Data de Vencimento"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 5).Value = "Multa"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 6).Value = "Juros ao Mês"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 7).Value = "Expiração em Horas"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 8).Value = "Descrição 1"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 9).Value = "Valor 1"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 10).Value = "Descrição 2"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 11).Value = "Valor 2"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 12).Value = "Descrição 3"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 13).Value = "Valor 3"
    
    With ActiveWindow
        '.SplitColumn = 13
        .SplitRow = 9
    End With
    ActiveWindow.FreezePanes = True
    
    initRow = 10
    lastRow = ActiveSheet.Cells(Rows.Count, "A").End(xlUp).row
    midRow = initRow - 1
    Do
        midRow = IIf(midRow + 100 >= lastRow, lastRow, midRow + 100)
        Set invoices = InvoiceGateway.getOrders(initRow, midRow)
        Set resp = InvoiceGateway.createInvoices(invoices)
        
        If resp.Status = 200 Then
            respMessage = resp.json()("message")
            MsgBox "Linhas " + CStr(initRow) + " a " + CStr(midRow) + ": " + resp.json()("message"), , "Sucesso"
            
        ElseIf resp.errors().Exists("errors") Then
            Dim errors As Collection: Set errors = resp.errors()("errors")
            Dim error As Dictionary
            Dim errorList As String
            Dim errorDescription As String
            Dim messageBox As String
            
            
            For Each error In errors
                errorDescription = Utils.correctErrorLine(error("message"), CLng(initRow))
                errorList = errorList & errorDescription & Chr(10)
            Next
            
            messageBox = errorList
            MsgBox messageBox, , "Erro"
            End
        Else
            MsgBox resp.errors()("errors")(1)("message"), , "Erro"
        End If
        
        initRow = initRow + 100
    Loop Until (midRow >= lastRow)
     
End Sub

Public Sub updateInvoices()
    Dim invoices As Collection
    Dim resp As Response
    Dim initRow As Long
    Dim midRow As Long
    Dim lastRow As Long
    Dim respMessage As String
    Dim reversingError As Boolean
    
    
    If Not isSignedin Then
        MsgBox "Acesso negado. Faça login novamente.", , "Erro"
        Exit Sub
    End If
    
    reversingError = False
    
    Call Utils.applyStandardLayout("B")
    Call Utils.applyLockedLayout("C", "D")
    
    'Headers definition
    ActiveSheet.Cells(TableFormat.HeaderRow(), 1).Value = "ID da Invoice"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 2).Value = "Valor final"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 3).Value = "Status"
    ActiveSheet.Cells(TableFormat.HeaderRow(), 4).Value = "Erro"
    
    With ActiveWindow
        '.SplitColumn = 4
        .SplitRow = 9
    End With
    
    ActiveWindow.FreezePanes = True
    ActiveSheet.Range("C10:D" & Range("A10").End(xlDown).row).ClearContents
    initRow = 10
    lastRow = ActiveSheet.Cells(Rows.Count, "A").End(xlUp).row
    midRow = initRow - 1
    Do
        midRow = IIf(midRow + 100 >= lastRow, lastRow, midRow + 100)
        Set invoices = InvoiceGateway.getUpdateOrders(initRow, midRow)
        Set resp = InvoiceGateway.updateInvoices(invoices)
        
        If resp.Status = 200 Then
            Dim line As Long
            
            
            line = initRow
            Do
                writeReversingResponse line, "Reversão solicitada com sucesso", ""
                line = line + 1
            Loop Until (line > midRow)
            
        ElseIf resp.errors().Exists("errors") Then
            Dim errors As Collection: Set errors = resp.errors()("errors")
            Dim error As Dictionary
            Dim errorList As String
            Dim errorDict As New Dictionary
            
            
            reversingError = True
            
            For Each error In errors
                Set errorDict = Utils.correctErrorSeparate(error("message"), CLng(initRow))
                writeReversingResponse errorDict("line"), "Erro ao solicitar reversão", errorDict("message")
            Next
            
        Else
            MsgBox resp.errors()("errors")(1)("message"), , "Erro"
            Exit Sub
            
        End If
        
        initRow = initRow + 100
    Loop Until (midRow >= lastRow)
     
End Sub

Public Sub SearchInvoicesByIds()
    Dim invoiceIds As Collection
    Dim resp As Response
    Dim initRow As Long
    Dim row As Long
    Dim midRow As Long
    Dim lastRow As Long
    Dim respMessage As String
    Dim query As New Dictionary
    Dim invoice As Variant
    Dim invoiceId As String
    
    
    If Not isSignedin Then
        MsgBox "Acesso negado. Faça login novamente.", , "Erro"
        Exit Sub
    End If

    initRow = 10
    lastRow = ActiveSheet.Cells(Rows.Count, "M").End(xlUp).row
    midRow = initRow - 1
    Do
        Dim invoiceMap As New Dictionary
        
        
        midRow = IIf(midRow + 100 >= lastRow, lastRow, midRow + 100)
        Set invoiceIds = InvoiceGateway.getInvoiceIds(initRow, midRow)
        query.Add "ids", CollectionToString(invoiceIds, ",")
        Set invoices = InvoiceGateway.getInvoices("", query)("invoices")
        
        For Each invoice In invoices
            invoiceId = invoice("id")
            invoiceMap.Add invoiceId, invoice
        Next
        
        row = initRow
        For Each queryId In invoiceIds
            If invoiceMap.Exists(queryId) Then
                Dim id As String: id = invoice("id")
                Dim amount As Double: amount = invoice("amount") / 100
                Dim nominalAmount As Double: nominalAmount = invoice("nominalAmount") / 100
                Dim discountAmount As Double: discountAmount = invoice("discountAmount") / 100
                Dim fineAmount As Double: fineAmount = invoice("fineAmount") / 100
                Dim interestAmount As Double: interestAmount = invoice("interestAmount") / 100
                Dim fee As Double: fee = invoice("fee") / 100
                Dim issueDate As String: issueDate = invoice("created")
                Dim invoiceStatus As String: invoiceStatus = invoice("status")
                Dim dueDate As String: dueDate = invoice("due")
                Dim expiration As Long: expiration = invoice("expiration")
                Dim tags As Collection: Set tags = invoice("tags")
                Dim expirationDate As Date: expirationDate = DateAdd("s", expiration, Utils.DatefromIsoString(dueDate))
                
                
                Set invoice = invoiceMap(queryId)
                
                ActiveSheet.Cells(row, 1).Value = Utils.ISODATEZ(issueDate)
                ActiveSheet.Cells(row, 2).Value = invoice("name")
                ActiveSheet.Cells(row, 3).Value = invoice("taxId")
                ActiveSheet.Cells(row, 4).Value = InvoiceGateway.getStatusInPt(invoiceStatus)
                ActiveSheet.Cells(row, 5).Value = amount
                ActiveSheet.Cells(row, 6).Value = nominalAmount
                ActiveSheet.Cells(row, 7).Value = discountAmount
                ActiveSheet.Cells(row, 8).Value = fineAmount
                ActiveSheet.Cells(row, 9).Value = interestAmount
                ActiveSheet.Cells(row, 10).Value = Utils.ISODATEZ(dueDate)
                ActiveSheet.Cells(row, 11).Value = Utils.ISODATEZ(Format(expirationDate, "yyyy-mm-ddThh:mm:ss"))
                ActiveSheet.Cells(row, 12).Value = invoice("brcode")
                ActiveSheet.Cells(row, 13).Value = id
                ActiveSheet.Cells(row, 14).Value = fee
                ActiveSheet.Cells(row, 15).Value = CollectionToString(tags, ",")
                
                ActiveSheet.Cells(row, 16).Value = "PDF"
                Set rng = ActiveSheet.Range("P" + CStr(row))
                rng.Parent.Hyperlinks.Add Anchor:=rng, address:=invoice("pdf"), SubAddress:="", TextToDisplay:="PDF"
            End If
            
            row = row + 1
        Next
        
        query.Remove "ids"
        initRow = initRow + 100
    Loop Until (midRow >= lastRow)
    
End Sub

Public Sub executeTransfers()
    SendTransferForm.Show
    
End Sub

Public Sub executeInternalTransfers()
    SendInternalTransferForm.Show
    
End Sub

Public Sub payCharges()
    SendChargePaymentForm.Show
End Sub

Public Sub searchChargePayments()
    ViewChargePaymentForm.Show
    
End Sub

Public Sub searchPaymentRequests()
    If Not isSignedin Then
        MsgBox "Acesso negado. Faça login novamente.", , "Erro"
        Exit Sub
    End If
    
    ViewRequestForm.Show
    
End Sub
