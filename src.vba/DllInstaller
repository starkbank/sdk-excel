
Public Sub installEcdsa()
    ' TODO: Need to think about how to manage updates to un this routine again when version changes
    ' this is register to windows
    Dim path As String: path = ActiveWorkbook.path
    
    
    If isEcdsaInstalled() = True And isEcdsaRegistered = True Then
        MsgBox "Ecdsa Instalado e registrado"
        Exit Sub
    End If
    
    MsgBox "Clique OK para instalar o pacote de autenticação StarkBank Ecdsa.É necessário incializar o excel no modo Administrador e reiniciar o computador após a instalação."
    
    If isEcdsaInstalled() = False Then
        Dim FSO As Object
        Dim SourceFileName As String, DestinFileName As String
        
        
        MsgBox "Ecdsa não esta instalado."
        
        On Error GoTo eh:
        workbookPath = ActiveWorkbook.path
        Set FSO = CreateObject("Scripting.Filesystemobject")
        
        SourceFileNameDll = workbookPath + "\StarkBankEcdsa.dll"
        DestinFileNameDll = "C:\Windows\System32\StarkBankEcdsa.dll"
        FSO.MoveFile Source:=SourceFileNameDll, Destination:=DestinFileNameDll
        
        SourceFileNameTlb = workbookPath + "\StarkBankEcdsa.tlb"
        DestinFileNameTlb = "C:\Windows\System32\StarkBankEcdsa.tlb"
        FSO.MoveFile Source:=SourceFileNameTlb, Destination:=DestinFileNameTlb
    End If
    
    Call Shell("reg " + path + "\StarkBankEcdsa.reg")
    Call AddReference
    Exit Sub
eh:
    MsgBox "Baixe uma nova versão do excel, arquivos estão faltando"
    Exit Sub
End Sub

Sub AddReference()
    Dim VBAEditor As VBIDE.VBE
    Dim vbProj As VBIDE.vbProject


    Set VBAEditor = Application.VBE
    Set vbProj = ActiveWorkbook.vbProject

    vbProj.References.AddFromFile "C:\WINDOWS\system32\StarkBankEcdsa.tlb"

End Sub

Public Function isEcdsaInstalled()
    Dim tlbFile As String
    Dim dllFile As String
    Dim result As Boolean
    
    
    tlbFile = Dir("C:\Windows\System32\StarkBankEcdsa.tlb")
    dllFile = Dir("C:\Windows\System32\StarkBankEcdsa.dll")

    result = True
    If tlbFile = "" Or dllFile = "" Then
        result = False
    End If
    
    isEcdsaInstalled = result
    
End Function

Public Function isEcdsaRegistered()
    Dim VBAEditor As VBIDE.VBE
    Dim vbProj As VBIDE.vbProject
    Dim chkRef As VBIDE.Reference
    Dim result As Boolean: result = False


    Set VBAEditor = Application.VBE
    Set vbProj = ActiveWorkbook.vbProject

    For Each chkRef In vbProj.References
        If chkRef.name = "StarkBankEcdsa" Then
            result = True
            GoTo CleanUp
        End If
    Next

CleanUp:
    Set vbProj = Nothing
    Set VBAEditor = Nothing
    isEcdsaRegistered = result

End Function
