
Public Function createOrders(teamId As String)
    Dim orders As New Collection
    Dim orderNumbers As New Collection
    Dim externalIds As New Collection
    Dim iteration As Integer
    Dim startRow As Integer
    Dim currentRow As Integer
    Dim resp As response
    Dim payload As String
    Dim dict As New Dictionary
    Dim request As Scripting.Dictionary
    Dim requests As New Collection
    Dim returnMessage As String
    Dim warningMessage As String
    Dim errorMessage As String
    Dim anySent As Boolean
    
    
    anySent = False
    returnMessage = ""
    warningMessage = ""
    errorMessage = ""

    
    iteration = 0
    startRow = TableFormat.HeaderRow() + 1
    
    For Each obj In SheetParser.dict
        Dim amount As Long
        Dim taxId As String
        Dim name As String
        Dim bankCode As String
        Dim branchCode As String
        Dim accountNumber As String
        Dim accountType As String
        Dim tags() As String
        Dim description As String
        Dim order As Dictionary
        
        iteration = iteration + 1
        currentRow = TableFormat.HeaderRow() + iteration
        
        If obj("Valor") = "" Then
            MsgBox "Por favor, não deixe linhas em branco entre as ordens de transferência", , "Erro"
            Unload SendOrderForm
            End
        End If
        amount = getAmountLong(obj("Valor"))
        taxId = Trim(obj("CPF/CNPJ"))
        name = Trim(obj("Nome"))
        bankCode = Trim(obj("Código do Banco/ISPB"))
        branchCode = Trim(obj("Agência"))
        accountNumber = Trim(obj("Conta"))
        accountType = getAccountType(obj("Tipo de Conta"))
        tags = Split(obj("Tags"), ",")
        description = obj("Descrição")
        externalId = obj("externalId")
        
        calculatedExternalId = calculateExternalId(amount, name, taxId, bankCode, branchCode, accountNumber)
        
        If calculatedExternalId = externalId Then
            warningMessage = "Aviso: Pedidos já enviados hoje não foram reenviados!" + Chr(10) + Chr(10)
        Else
            Set request = New Scripting.Dictionary
            Set order = V2CostCenterGateway.order(amount, taxId, name, bankCode, branchCode, accountNumber, accountType, description)
            orders.Add order
            orderNumbers.Add iteration
            externalIds.Add calculatedExternalId
            request.Add "centerId", teamId
            request.Add "type", "transfer"
            request.Add "payment", order
            request.Add "tags", tags
            requests.Add request
            
        End If
        
        If (iteration Mod 100) = 0 Or (currentRow >= ActiveSheet.Cells(Rows.Count, "A").End(xlUp).row) Then
            If orderNumbers.Count = 0 Then
                Set orders = Nothing
                Set orderNumbers = Nothing
                Set externalIds = Nothing
                GoTo nextIteration
            End If
            
            If dict.Exists("requests") Then
                dict.RemoveAll
            End If
            
            dict.Add "requests", requests
            Set requests = New Collection
            payload = JsonConverter.ConvertToJson(dict)

            Set resp = V2Rest.postRequest("/v2/payment-request", payload, New Dictionary)
            anySent = True
            
            If resp.Status = 200 Then
                createOrders = resp.json()("message")
                returnMessage = returnMessage + rowsMessage(startRow, currentRow) + resp.json()("message") + Chr(10)
                Dim j As Integer
                For j = 1 To externalIds.Count
                    ActiveSheet.Cells(TableFormat.HeaderRow() + orderNumbers.Item(j), 10).Value = externalIds.Item(j)
                Next j
                
            ElseIf resp.errors().Exists("errors") Then
                Dim errors As Collection: Set errors = resp.errors()("errors")
                Dim error As Dictionary
                Dim errorDescription As String
                
                For Each error In errors
                    errorDescription = Utils.correctErrorLine(error("message"), startRow)
                    errorMessage = errorMessage + errorDescription + Chr(10)
                Next
                
            Else
                errorDescription = Utils.correctErrorLine(resp.errors()("message"), startRow)
                errorMessage = errorMessage + errorDescription + Chr(10)
        
            End If
nextIteration:
            startRow = currentRow + 1
            Set orders = Nothing
            Set orderNumbers = Nothing
            Set externalIds = Nothing
        End If
        
    Next
    If anySent Then
        MsgBox warningMessage + Chr(10) + returnMessage + Chr(10) + errorMessage
    Else
        MsgBox "Todos os pedidos listados já foram enviados"
    End If
End Function

Public Function order(amount As Long, taxId As String, name As String, bankCode As String, branchCode As String, accountNumber As String, accountType As String, description As String) As Dictionary
    Dim dict As New Dictionary
    
    dict.Add "amount", amount
    dict.Add "taxId", taxId
    dict.Add "name", name
    dict.Add "bankCode", bankCode
    dict.Add "branchCode", branchCode
    dict.Add "accountNumber", accountNumber
    dict.Add "accountType", accountType
    dict.Add "description", description
    
    Set order = dict
    
End Function

Public Function createChargePayments(teamId As String)
    Dim chargePayments As New Collection
    Dim chargePaymentNumbers As New Collection
    Dim externalIds As New Collection
    Dim iteration As Integer
    Dim startRow As Integer
    Dim currentRow As Integer
    Dim resp As response
    Dim payload As String
    Dim dict As New Dictionary
    Dim request As Scripting.Dictionary
    Dim requests As New Collection
    Dim returnMessage As String
    Dim warningMessage As String
    Dim errorMessage As String
    Dim anySent As Boolean
    
    anySent = False
    returnMessage = ""
    warningMessage = ""
    errorMessage = ""

    
    iteration = 0
    startRow = TableFormat.HeaderRow() + 1
    
    For Each obj In SheetParser.dict
        Dim code As String
        Dim taxId As String
        Dim scheduledDate As String
        Dim tags() As String
        Dim description As String
        Dim chargePayment As Dictionary
        
        iteration = iteration + 1
        currentRow = TableFormat.HeaderRow() + iteration
        
        If obj("Linha Digitável ou Código de Barras") = "" Then
            MsgBox "Por favor, não deixe linhas em branco entre as ordens de transferência", , "Erro"
            Unload SendChargePaymentForm
            End
        End If
        code = obj("Linha Digitável ou Código de Barras")
        taxId = Trim(obj("CPF/CNPJ do Beneficiário"))
        scheduledDate = obj("Data de Agendamento")
        tags = Split(obj("Tags"), ",")
        description = obj("Descrição")
        externalId = obj("externalId")
        
        calculatedExternalId = code + name + taxId + scheduledDate
        
        If calculatedExternalId = externalId Then
            warningMessage = "Aviso: Pedidos já enviados hoje não foram reenviados!" + Chr(10) + Chr(10)
        Else
            Set request = New Scripting.Dictionary
            Set chargePayment = V2CostCenterGateway.chargePayment(code, taxId, tags(), description)
            chargePayments.Add chargePayment
            chargePaymentNumbers.Add iteration
            externalIds.Add calculatedExternalId
            request.Add "centerId", teamId
            request.Add "type", "boleto-payment"
            request.Add "payment", chargePayment
            request.Add "due", Utils.DateToSendingFormat(Format(scheduledDate, "dd/mm/yyyy"))
            request.Add "tags", tags
            requests.Add request
            
        End If

        If (iteration Mod 100) = 0 Or (currentRow >= ActiveSheet.Cells(Rows.Count, "A").End(xlUp).row) Then
            If chargePaymentNumbers.Count = 0 Then
                Set chargePayments = Nothing
                Set chargePaymentNumbers = Nothing
                Set externalIds = Nothing
                GoTo nextIteration
            End If

            dict.Add "requests", requests
            payload = JsonConverter.ConvertToJson(dict)

            Set resp = V2Rest.postRequest("/v2/payment-request", payload, New Dictionary)
            anySent = True

            If resp.Status = 200 Then
                createChargePayments = resp.json()("message")
                returnMessage = returnMessage + rowsMessage(startRow, currentRow) + resp.json()("message") + Chr(10)
                Dim j As Integer
                For j = 1 To externalIds.Count
                    ActiveSheet.Cells(TableFormat.HeaderRow() + chargePaymentNumbers.Item(j), 10).Value = externalIds.Item(j)
                Next j

            ElseIf resp.errors().Exists("errors") Then
                Dim errors As Collection: Set errors = resp.errors()("errors")
                Dim error As Dictionary
                Dim errorDescription As String

                For Each error In errors
                    errorDescription = Utils.correctErrorLine(error("message"), startRow)
                    errorMessage = errorMessage + errorDescription + Chr(10)
                Next

            Else
                errorDescription = Utils.correctErrorLine(resp.errors()("message"), startRow)
                errorMessage = errorMessage + errorDescription + Chr(10)

            End If
nextIteration:
            startRow = currentRow + 1
            Set chargePayments = Nothing
            Set chargePaymentNumbers = Nothing
            Set externalIds = Nothing
        End If

    Next
    If anySent Then
        MsgBox warningMessage + Chr(10) + returnMessage + Chr(10) + errorMessage
    Else
        MsgBox "Todos os pedidos listados já foram enviados"
    End If
End Function

Public Function chargePayment(code As String, taxId As String, tags() As String, description As String) As Dictionary
    Dim dict As New Dictionary
    
    numberOfSpaces = countSpaces(code)
    numberOfCharacters = Len(code) - nSpaces
    
    If numberOfCharacters <> 44 Then
        dict.Add "line", code
    Else
        dict.Add "barCode", code
    End If
    
    dict.Add "taxId", taxId
    dict.Add "tags", tags
    dict.Add "description", description
    
    Set chargePayment = dict
    
End Function

Public Function createInternalTransfer(teamId As String, amount As Long, description As String, externalId As String, receiverId As String, tags() As String)
    Dim internalTransfer As Dictionary
    Dim resp As response
    Dim payload As String
    Dim dict As New Dictionary
    Dim request As New Scripting.Dictionary
    Dim requests As New Collection
    Dim returnMessage As String
    Dim warningMessage As String
    Dim errorMessage As String
    Dim anySent As Boolean
    
    
    returnMessage = ""
    warningMessage = ""
    errorMessage = ""
        
    Set internalTransfer = V2CostCenterGateway.internalTransfer(amount, description, externalId, receiverId, tags())
    
    request.Add "centerId", teamId
    request.Add "type", "transaction"
    request.Add "payment", internalTransfer

    requests.Add request
    dict.Add "requests", requests
    payload = JsonConverter.ConvertToJson(dict)

    Set resp = V2Rest.postRequest("/v2/payment-request", payload, New Dictionary)

    If resp.Status = 200 Then
        anySent = True
        createInternalTransfer = resp.json()("message")
        returnMessage = resp.json()("message")

        ActiveSheet.Cells(TableFormat.HeaderRow() + 1, 10).Value = externalId


    ElseIf resp.errors().Exists("errors") Then
        Dim errors As Collection: Set errors = resp.errors()("errors")
        Dim error As Dictionary

        For Each error In errors
            errorMessage = error("message") + Chr(10)
        Next

    Else
        errorMessage = resp.errors()("message") + Chr(10)

    End If

    MsgBox returnMessage + Chr(10) + errorMessage
    
End Function

Public Function internalTransfer(amount As Long, description As String, externalId As String, receiverId As String, tags() As String) As Dictionary
    Dim dict As New Dictionary
    
    dict.Add "amount", amount
    dict.Add "description", description
    dict.Add "externalId", externalId
    dict.Add "receiverId", receiverId
    dict.Add "tags", tags
    
    Set internalTransfer = dict
    
End Function
